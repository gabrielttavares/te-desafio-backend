flowchart TB
    subgraph Cadastro
        A1[Cliente: POST /auth/register] --> A2[Controller: valida DTO]
        A2 --> A3{email já existe?}
        A3 -->|Sim| A4[409 Conflict]
        A3 -->|Não| A5[Service: hash da senha, salva User]
        A5 --> A6[Gera JWT / AuthResponse]
        A6 --> A7[200 + token + user]
    end

    subgraph Login
        B1[Cliente: POST /auth/login] --> B2[Controller: LoginRequest]
        B2 --> B3[Service: loadUserByUsername, BCrypt.matches]
        B3 --> B4{Credenciais OK?}
        B4 -->|Não| B5[401 Unauthorized]
        B4 -->|Sim| B6[Gera JWT, AuthResponse]
        B6 --> B7[200 + token + user]
    end

    subgraph CriarDesafio
        C1[Cliente: POST /api/challenges + Bearer] --> C2[JwtFilter: valida token, SecurityContext]
        C2 --> C3[Controller: CreateChallengeRequest]
        C3 --> C4[Service: cria Challenge, creator = user do token]
        C4 --> C5[Repository.save]
        C5 --> C6[201 + ChallengeResponse]
    end

    subgraph Participacao
        D1[Cliente: POST /challenges/:id/join ou aceitar Invite] --> D2[Controller + Bearer]
        D2 --> D3[Service: busca Challenge, User do token]
        D3 --> D3a{visibility?}
        D3a -->|PRIVATE + join| D3b[403/400: só via Invite]
        D3a -->|PUBLIC + join ou Invite aceito| D4{Já participante?}
        D4 -->|Sim| D5[409 Conflict]
        D4 -->|Não| D6[Cria ChallengeParticipant, joinedAt=now]
        D6 --> D7[Repository.save]
        D7 --> D8[201]
    end

    subgraph RegistroDiario
        E1[Cliente: POST /api/daily-logs + Bearer] --> E2[Controller: CreateDailyLogRequest]
        E2 --> E3[Service: valida que user é participante; checa allowMultipleLogsPerDay]
        E3 --> E3x{allowMultiple=false e já existe log no dia?}
        E3x -->|Sim| E3y[409]
        E3x -->|Não| E4[Cria DailyLog: participant, challenge, loggedAt, completed]
        E4 --> E5[Repository.save]
        E5 --> E6[201 + DailyLogResponse]
    end

    subgraph Ranking
        F1[Cliente: GET /api/challenges/:id/ranking + Bearer] --> F2[Controller]
        F2 --> F3[Service: busca DailyLogs do challenge onde completed=true]
        F3 --> F4[Agrupa por participant/user, conta totais]
        F4 --> F5[Ordena decrescente, atribui position]
        F5 --> F6[Monta lista RankingEntryResponse]
        F6 --> F7[200 + ranking]
    end

    A7 --> B1
    B7 --> C1
    C6 --> D1
    D8 --> E1
    E6 --> F1
